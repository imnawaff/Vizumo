class GameScene: SKScene {
    enum State {
        case menu, playing
    }

    var gameState: State = .menu
    var startLabel: SKLabelNode!
    var spawnTimer: Timer?

    var score = 0
    var scoreLabel: SKLabelNode!

    override func didMove(to view: SKView) {
        backgroundColor = .black
        showStartLabel()
        setupScoreLabel()
    }

    func showStartLabel() {
        startLabel = SKLabelNode(fontNamed: "AvenirNext-Bold")
        startLabel.text = "Tap to Start"
        startLabel.fontSize = 36
        startLabel.fontColor = .green
        startLabel.position = CGPoint(x: frame.midX, y: frame.midY)
        addChild(startLabel)
    }

    func setupScoreLabel() {
        scoreLabel = SKLabelNode(fontNamed: "AvenirNext-Bold")
        scoreLabel.fontSize = 28
        scoreLabel.fontColor = .white
        scoreLabel.position = CGPoint(x: frame.midX, y: frame.maxY - 80)
        scoreLabel.text = "Score: 0"
        scoreLabel.zPosition = 10
        addChild(scoreLabel)
    }

    func updateScore() {
        score += 1
        scoreLabel.text = "Score: \(score)"
    }

    func startGame() {
        gameState = .playing
        score = 0
        updateScore()
        startLabel.removeFromParent()
        startSpawningBalls()
    }

    func startSpawningBalls() {
        spawnBall()
        spawnTimer = Timer.scheduledTimer(withTimeInterval: 1.5, repeats: true) { _ in
            self.spawnBall()
        }
    }

    func spawnBall() {
        let ball = SKShapeNode(circleOfRadius: 30)
        ball.fillColor = .red
        ball.name = "ball"
        let x = CGFloat.random(in: 60...(size.width - 60))
        ball.position = CGPoint(x: x, y: size.height + 60)
        addChild(ball)

        let move = SKAction.moveTo(y: -60, duration: 3.0)
        let remove = SKAction.removeFromParent()
        ball.run(SKAction.sequence([move, remove]))
    }

    override func touchesBegan(_ touches: Set<UITouch>, with event: UIEvent?) {
        guard let location = touches.first?.location(in: self) else { return }

        switch gameState {
        case .menu:
            startGame()
        case .playing:
            let nodesHere = nodes(at: location)
            for node in nodesHere {
                if node.name == "ball" {
                    node.removeFromParent()
                    updateScore()
                }
            }
        }
    }
}